<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEC Pak 585 Serial Tester</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #response { 
            margin-top: 20px; 
            white-space: pre-wrap; 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ccc; 
            padding: 10px; 
            font-family: monospace;
        }
        .config-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .config-item { display: flex; flex-direction: column; align-items: center; }
        label { margin-bottom: 5px; font-size: 14px; }
        select, input { width: 100px; }
        #command { width: 300px; }
    </style>
</head>
<body>
    <h1>TEC Pak 585 Serial API Tester</h1>
    <p>Configure the serial port settings, connect, then select or type a SCPI command, and use Query or Write.</p>
    
    <h2>Serial Port Configuration</h2>
    <div class="config-row">
        <div class="config-item">
            <label for="addPort">Connect</label>
            <button id="addPort">Connect</button>
        </div>
        <div class="config-item">
            <label for="baud">Baud Rate</label>
            <select id="baud">
                <option value="9600">9600</option>
                <option value="14400">14400</option>
                <option value="19200">19200</option>
                <option value="38400" selected>38400</option>
                <option value="57600">57600</option>
                <option value="115200">115200</option>
            </select>
        </div>
        <div class="config-item">
            <label for="databits">Data Bits</label>
            <select id="databits">
                <option value="7">7</option>
                <option value="8" selected>8</option>
            </select>
        </div>
        <div class="config-item">
            <label for="stopbits">Stop Bits</label>
            <select id="stopbits">
                <option value="1" selected>1</option>
                <option value="2">2</option>
            </select>
        </div>
        <div class="config-item">
            <label for="parity">Parity</label>
            <select id="parity">
                <option value="none" selected>none</option>
                <option value="even">even</option>
                <option value="odd">odd</option>
            </select>
        </div>
        <div class="config-item">
            <label for="flowcontrol">Flow Control</label>
            <select id="flowcontrol">
                <option value="none" selected>none</option>
                <option value="hardware">hardware</option>
            </select>
        </div>
        <div class="config-item">
            <label for="timeout">Timeout (ms)</label>
            <input id="timeout" type="number" value="1000" min="100">
        </div>
    </div>
    
    <button id="disconnect">Disconnect</button>
    <br><br>
    
    <label for="command">SCPI Command:</label>
    <input id="command" list="commands" value="*IDN?" style="width: 300px;">
    
    <datalist id="commands">
        <option value="*CLS"></option>
        <option value="*ESE"></option>
        <option value="*ESE?"></option>
        <option value="*ESR?"></option>
        <option value="*IDN?"></option>
        <option value="*IST?"></option>
        <option value="*PRE"></option>
        <option value="*PRE?"></option>
        <option value="*PSC"></option>
        <option value="*PSC?"></option>
        <option value="*RCL"></option>
        <option value="*RST"></option>
        <option value="*SRE"></option>
        <option value="*SRE?"></option>
        <option value="*STB?"></option>
        <option value="*TST?"></option>
        <option value="*WAI"></option>
        <option value="BEEP"></option>
        <option value="BEEP?"></option>
        <option value="BRIGHT"></option>
        <option value="BRIGHT?"></option>
        <option value="DELAY"></option>
        <option value="EQUIPment?"></option>
        <option value="ERRors?"></option>
        <option value="ERRSTR?"></option>
        <option value="LOCAL"></option>
        <option value="MESsage"></option>
        <option value="MESsage?"></option>
        <option value="ONDELAY"></option>
        <option value="ONDELAY?"></option>
        <option value="RADix"></option>
        <option value="RADix?"></option>
        <option value="REMERR"></option>
        <option value="REMERR?"></option>
        <option value="SCRIPT:GET"></option>
        <option value="SCRIPT:GO"></option>
        <option value="SCRIPT:PUT"></option>
        <option value="TERM"></option>
        <option value="TERM?"></option>
        <option value="TERMINAL"></option>
        <option value="TERMINAL?"></option>
        <option value="TIME?"></option>
        <option value="TIMER?"></option>
        <option value="TEC:ANALOG:MODE"></option>
        <option value="TEC:ANALOG:MODE?"></option>
        <option value="TEC:ANALOG:RES"></option>
        <option value="TEC:ANALOG:RES?"></option>
        <option value="TEC:ANALOG:THIGH"></option>
        <option value="TEC:ANALOG:THIGH?"></option>
        <option value="TEC:ANALOG:TLOW"></option>
        <option value="TEC:ANALOG:TLOW?"></option>
        <option value="TEC:AUTOTUNE"></option>
        <option value="TEC:AUTOTUNE?"></option>
        <option value="TEC:AUTOTUNESTATE?"></option>
        <option value="TEC:CABLER"></option>
        <option value="TEC:CABLER?"></option>
        <option value="TEC:CABLETYPE?"></option>
        <option value="TEC:COND?"></option>
        <option value="TEC:CONST"></option>
        <option value="TEC:CONST?"></option>
        <option value="TEC:DEC"></option>
        <option value="TEC:DISplay"></option>
        <option value="TEC:DISplay?"></option>
        <option value="TEC:ENABle:COND"></option>
        <option value="TEC:ENABle:COND?"></option>
        <option value="TEC:ENABle:EVEnt"></option>
        <option value="TEC:ENABle:EVEnt?"></option>
        <option value="TEC:ENABle:OUTOFF"></option>
        <option value="TEC:ENABle:OUTOFF?"></option>
        <option value="TEC:EVEnt?"></option>
        <option value="TEC:FAN"></option>
        <option value="TEC:FAN?"></option>
        <option value="TEC:GAIN"></option>
        <option value="TEC:GAIN?"></option>
        <option value="TEC:HEATCOOL"></option>
        <option value="TEC:HEATCOOL?"></option>
        <option value="TEC:INC"></option>
        <option value="TEC:INVERTITE"></option>
        <option value="TEC:INVERTITE?"></option>
        <option value="TEC:ITE"></option>
        <option value="TEC:ITE?"></option>
        <option value="TEC:LIMit:ITE"></option>
        <option value="TEC:LIMit:ITE?"></option>
        <option value="TEC:LIMit:RHI"></option>
        <option value="TEC:LIMit:RHI?"></option>
        <option value="TEC:LIMit:RLO"></option>
        <option value="TEC:LIMit:RLO?"></option>
        <option value="TEC:LIMit:THI"></option>
        <option value="TEC:LIMit:THI?"></option>
        <option value="TEC:LIMit:TLO"></option>
        <option value="TEC:LIMit:TLO?"></option>
        <option value="TEC:MODE:ITE"></option>
        <option value="TEC:MODE:R"></option>
        <option value="TEC:MODE:T"></option>
        <option value="TEC:MODE?"></option>
        <option value="TEC:OUTput"></option>
        <option value="TEC:OUTput?"></option>
        <option value="TEC:PID"></option>
        <option value="TEC:PID?"></option>
        <option value="TEC:R"></option>
        <option value="TEC:R?"></option>
        <option value="TEC:SENsor"></option>
        <option value="TEC:SENsor?"></option>
        <option value="TEC:SET:ITE?"></option>
        <option value="TEC:SET:R?"></option>
        <option value="TEC:SET:T?"></option>
        <option value="TEC:STB?"></option>
        <option value="TEC:STEP"></option>
        <option value="TEC:STEP?"></option>
        <option value="TEC:T"></option>
        <option value="TEC:T?"></option>
        <option value="TEC:TOLerance"></option>
        <option value="TEC:TOLerance?"></option>
        <option value="TEC:TRATE"></option>
        <option value="TEC:TRATE?"></option>
        <option value="TEC:USERCAL:EDIT"></option>
        <option value="TEC:USERCAL:EDIT?"></option>
        <option value="TEC:USERCAL:GET?"></option>
        <option value="TEC:USERCAL:PUT"></option>
        <option value="TEC:USERCAL:RESET"></option>
        <option value="TEC:V?"></option>
    </datalist>
    
    <button id="query">Query (Send & Read)</button>
    <button id="write">Write (Send Only)</button>
    
    <div id="response"></div>
    
    <script>
        let port;
        let writer;
        let reader;
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();
        const responseDiv = document.getElementById('response');
        let portsList = [];
        const maxLogSize = 10000; // ~10KB in bytes

        function getTimestamp() {
            const now = new Date();
            return now.toLocaleString('en-US', { hour12: true });
        }

        function appendToLog(message) {
            const currentContent = responseDiv.textContent;
            const newContent = `${currentContent ? currentContent + '\n' : ''}${message}`;
            responseDiv.textContent = newContent;
            if (newContent.length > maxLogSize) {
                const excess = newContent.length - maxLogSize;
                const trimmedContent = newContent.substring(excess);
                const firstNewline = trimmedContent.indexOf('\n');
                responseDiv.textContent = firstNewline !== -1 ? trimmedContent.substring(firstNewline + 1) : trimmedContent;
            }
            responseDiv.scrollTop = responseDiv.scrollHeight;
        }

        document.getElementById('addPort').addEventListener('click', async () => {
            try {
                if (port) {
                    if (reader) { reader.releaseLock(); reader = null; }
                    if (writer) { writer.releaseLock(); writer = null; }
                    await port.close();
                    port = null;
                    appendToLog(`${getTimestamp()}: Disconnected from previous port.`);
                }
                const newPort = await navigator.serial.requestPort();
                if (!newPort) return;
                portsList.push(newPort);
                port = newPort;
                await port.open({
                    baudRate: parseInt(document.getElementById('baud').value),
                    dataBits: parseInt(document.getElementById('databits').value),
                    stopBits: parseInt(document.getElementById('stopbits').value),
                    parity: document.getElementById('parity').value,
                    flowControl: document.getElementById('flowcontrol').value
                });
                writer = port.writable.getWriter();
                reader = port.readable.getReader();
                appendToLog(`${getTimestamp()}: Connected to new port.`);
            } catch (error) {
                appendToLog(`${getTimestamp()}: Error connecting: ${error.message}`);
            }
        });

        document.getElementById('disconnect').addEventListener('click', async () => {
            if (!port) {
                appendToLog(`${getTimestamp()}: No port connected.`);
                return;
            }
            try {
                if (reader) { reader.releaseLock(); reader = null; }
                if (writer) { writer.releaseLock(); writer = null; }
                await port.close();
                appendToLog(`${getTimestamp()}: Disconnected from port.`);
                port = null;
            } catch (error) {
                appendToLog(`${getTimestamp()}: Error disconnecting: ${error.message}`);
            }
        });

        async function sendCommand(cmd, readBack = false) {
            if (!port || !writer) {
                appendToLog(`${getTimestamp()}: Not connected to serial port.`);
                return;
            }
            const timeout = parseInt(document.getElementById('timeout').value);
            appendToLog(`${getTimestamp()}: Sending command: ${cmd}`);
            try {
                await writer.write(encoder.encode(cmd + '\r\n'));
                if (readBack) {
                    let data = '';
                    const timeoutId = setTimeout(() => { reader.cancel(); }, timeout);
                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            data += decoder.decode(value);
                            if (data.includes('\n')) break;
                        }
                        clearTimeout(timeoutId);
                        appendToLog(`${getTimestamp()}: Response: ${data.trim() || 'No response'}`);
                    } catch (e) {
                        clearTimeout(timeoutId);
                        appendToLog(`${getTimestamp()}: Timeout or error: ${e.message}`);
                    }
                } else {
                    appendToLog(`${getTimestamp()}: Command sent.`);
                }
            } catch (error) {
                appendToLog(`${getTimestamp()}: Error: ${error.message}`);
            } finally {
                if (readBack) {
                    reader.releaseLock();
                    reader = port.readable.getReader();
                }
            }
        }

        document.getElementById('query').addEventListener('click', () => {
            sendCommand(document.getElementById('command').value, true);
        });

        document.getElementById('write').addEventListener('click', () => {
            sendCommand(document.getElementById('command').value, false);
        });
    </script>
</body>
</html>
